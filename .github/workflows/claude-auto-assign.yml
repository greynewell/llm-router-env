name: Claude Auto-Assign

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check authorization and trigger Claude
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          # Check if issue contains @claude
          if ! echo "$ISSUE_BODY" | grep -q "@claude"; then
            echo "Issue does not mention @claude, skipping"
            exit 0
          fi

          # CUSTOMIZE: Authorization check â€” pick one:

          # Bot allowlist: trusted automation bots are authorized automatically
          # This enables the self-improvement loop (scanner-created issues reach Claude)
          case "$ISSUE_AUTHOR" in
            "github-actions[bot]"|"claude[bot]")
              AUTHORIZED=true
              ;;
            *)
              # Option 1: Restrict to specific username(s)
              ALLOWED_USERS="greynewell"
              if echo "$ALLOWED_USERS" | grep -qw "$ISSUE_AUTHOR"; then
                AUTHORIZED=true
              else
                AUTHORIZED=false
              fi
              ;;
          esac

          # Option 2: Open to all users (uncomment to use)
          # AUTHORIZED=true

          # Option 3: Org membership check (uncomment to use)
          # ORG="your-org-name"
          # if gh api orgs/$ORG/members/$ISSUE_AUTHOR --silent 2>/dev/null; then
          #   AUTHORIZED=true
          # else
          #   AUTHORIZED=false
          # fi

          if [ "$AUTHORIZED" = "true" ]; then
            gh issue comment $ISSUE_NUMBER --repo $REPO \
              --body "@claude please implement this issue"
          else
            echo "User $ISSUE_AUTHOR not authorized, skipping"
          fi
