name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  claude-code-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "claude[bot],github-actions[bot]"
          claude_args: '--allowedTools "Bash(gh pr view:*),Bash(gh api:*),Read,Glob,Grep"'
          prompt: |
            Review this pull request for:
            1. Correctness and logic errors
            2. Security vulnerabilities
            3. Breaking changes

            Post review comments inline on the diff using the GitHub API.
            Be concise. Focus on significant issues only.
            Additionally, for this Python/Gymnasium/Stable-Baselines3 codebase, also check:
            4. Gymnasium API compliance — reset() must return (obs, info) tuple (Gymnasium 1.0+, not just obs); step() must return (obs, reward, terminated, truncated, info) 5-tuple, not the legacy 4-tuple
            5. Reward function correctness — the reward formula must match the spec: r = -cost_weight * cost + quality_weight * quality - latency_penalty * max(0, latency - sla_threshold)
            6. Action/observation space definitions — action space must be Discrete(n_models); observation space must be Box with the correct shape (prompt_length, prompt_complexity, queue_depths per model, time_of_day, budget_remaining)
            7. No hardcoded model configs — new models must be defined in llm_router_env/models.py, not inline in other files
            8. Test coverage — any changes to env.py, reward.py, or models.py must include corresponding pytest tests

            After posting inline comments, submit a formal review decision using the GitHub API.
            Determine whether blocking issues were found (significant bugs, security vulnerabilities, or breaking changes).
            If no blocking issues:
              gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews --method POST --field body='LGTM' --field event=APPROVE
            If blocking issues found:
              gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews --method POST --field body='Changes required: [summarize issues]' --field event=REQUEST_CHANGES
            Only use REQUEST_CHANGES for significant bugs, security vulnerabilities, or breaking changes. Use APPROVE for minor issues, style comments, or suggestions.
          # CUSTOMIZE: Restrict to read-only tools
          # claude_args: "--allowedTools Bash(go vet ./...),Bash(go test ./...)"
